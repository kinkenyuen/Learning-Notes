# 互联网音视频

目前互联网提供的音频/视频服务大体上可分为三种类型：

* **流式(streaming)存储音频/视频** 

  这种类型是先把已压缩的录制好的音频/视频文件存储在服务器上。用户通过互联网下载这样的文件。注意，用户并不是把文件全部下载完毕后再播放，因为这往往需要很长时间，而用户一般也不大愿意等待太长的时间。流式存储音频/视频文件的特点是能够**边下载边播放**，即在文件下载后不久(例如，一般在缓存中存放最大几十秒)就开始连续播放

* **流式实况音频/视频** 

  这种类型和无线电台或电视台的实况广播相似，不同之处是音频/视频节目的广播是通过互联网来传送的。流式实况音频/视频是一对多(而不是一对一)的通信。它的特点是：音频/视频节目不是事先录制好和存储在服务器中的，而是在发送方边录制边发送(不是录制完毕后再发送)。在接收时也要求能够连续播放。接收方收到节目的时间和节目中事件的发生时间可以认为是同时的(相差仅仅是电磁波的传播时间和很短的信号处理时间)。**流式实况音频/视频按理说应当采用多播技术才能提高网络资源的利用率，但目前实际上还是使用多个独立的单播**

* **交互式音频/视频**

  这种类型是用户使用互联网和其他人进行**实时**交互式通信。现在的互联网电话或互联网电视会议就属于这种类型

注意，对于流式音频/视频的"下载"，实际上并没有把"下载"的内容存储在硬盘上。因此当"边下载边播放"结束后，在用户的硬盘上没有留下有关播放内容的任何痕迹。播放流式音频/视频的用户，仅仅能够在屏幕上观看播放的内容，也不能把播放的内容存储下来，因此也无法进行转发。这对保护版权非常有利

目前的技术发展，已经有了能够存储在网上播放的流式音频/视频文件的软件

我们现在常见的词汇**流媒体**（streaming media）就是上面所说的流式音频/视频。流媒体主要的特点就是不是全部都收录下来再播放

# 流式存储音频/视频

这种方式的音视频播放，通常是用户从浏览器通过HTTP协议请求，从服务器获取音视频文件，完全下载到本地后使用自己机器上的媒体播放器进行解压缩，然后播放

这种传统的下载文件的方法并没有涉及到"流式"(即边下载边播放)的概念。传统的下载方法最大缺点就是历时太长，这往往使下载者不愿继续等待。为此，目前已经找出了几种改进的措施

## 具有元文件的万维网服务器

第一种改进的措施就是在万维网服务器中，除了真正的音频/视频文件外，还增加了一个**元文件**(metafile)。所谓元文件（请注意，不是源文件）就是一种非常小的文件，它描述或指明其他文件的一些重要信息。这里的元文件保存了有关这个音频/视频文件的信息。下图说明了使用元文件下载音频/视频文件的几个步骤

<div align="center">    
<img src="./imgs/元文件播放.jpg" width="50%" height="50%">
</div>

1. 浏览器用户点击所要看的音频/视频文件的超链，使用HTTP的GET报文接入到万
   维网服务器。实际上，这个超链并没有直接指向所请求的音频/视频文件，而是指向一个元文件。这个元文件有实际的音频/视频文件的统一资源定位符URL
2. 万维网服务器把该元文件装入HTTP响应报文的主体，发回给浏览器。在响应报文中还有指明该音频/视频文件类型的首部
3. 客户机浏览器收到万维网服务器的响应，分析其内容类型首部行，调用相关的媒体
   播放器（客户机中可能装有多个媒体播放器），把提取出的元文件传送给媒体播放器
4. 媒体播放器使用元文件中的URL直接和万维网服务器建立TCP连接，并向万维网
   服务器发送HTTP请求报文，要求下载浏览器想要的音频/视频文件
5. 万维网服务器发送HTTP响应报文，把该音频/视频文件发送给媒体播放器。媒体播放器在存储了若干秒的音频/视频文件后（这是为了消除抖动），就以音频/视频流的形式边下载、边解压缩、边播放

## 媒体服务器

为了更好地提供播放流式音频/视频文件的服务，现在最为流行的做法就是使用两个分开的服务器。如下图所示，现在使用一个普通的万维网服务器，和另一个**媒体播放器**（media server）。媒体服务器和万维网服务器可以运行在一个端系统内，也可以运行在两个不同的端系统中。媒体服务器与普通的万维网服务器的最大区别就是，媒体服务器是专门为播放流式音频/视频文件而设计的，因此能够更加有效地为用户提供播放流式多媒体文件的服务。因此媒体服务器也常被称为**流式服务器**（streaming server）。下面介绍其工作原理

<div align="center">    
<img src="./imgs/媒体服务器播放.jpg" width="50%" height="50%">
</div>

在用户端的媒体播放器与媒体服务器的关系是客户与服务器的关系。与之前不同的是，现在媒体播放器不是向万维网服务器而是向媒体服务器请求音频/视频文件。**媒体服务器和媒体播放器之间采用另外的协议进行交互**。
采用媒体服务器后，下载音频/视频文件的前三个步骤仍然和上一节所述的一样，区别就是后面两个步骤，即：

  1 ~ 3.  前三个步骤与上一节的相同

4. 媒体播放器使用元文件中的URL接入到媒体服务器，请求下载浏览器所请求的音频/视频文件。下载文件可以使用上一节描述的HTTP/TCP，也可以借助于使用UDP的任何协议，例如使用**实时运输协议RTP**(后面描述)
5. 媒体服务器给出响应，把该音频/视频文件发送给媒体播放器。媒体播放器在迟延了若干秒后(例如，2~5秒)，以流的形式边下载、边解压缩、边播放

上面提到，传送音频/视频文件可以使用TCP，也可以使用UDP。起初人们选用UDP来传送。不采用TCP的主要原因是担心当网络出现分组丢失时，TCP的重传机制会使重传的分组不能按时到达接收端，使得媒体播放器的播放不流畅。但后来的实践经验发现，采用UDP会有以下几个缺点

* 发送端按正常播放的速率发送流媒体数据帧，但由于网络的情况多变，在接收端的播放器很难做到始终按规定的速率播放。例如，一个视频节目需要以1Mbit/s的速率播放。如果从媒体服务器到媒体播放器之间的网络容量突然降低到1Mbit/s以下，那么这时就会出现播放器的暂停，影响正常的观看
* 很多单位的防火墙往往阻拦外部UDP分组的进入，因而使用UDP传送多媒体文件时会被防火墙阻拦掉
* 使用UDP传送流式多媒体文件时，如果在用户端希望能够控制媒体的播放，如进行暂停、快进等操作，那么还需要使用另外的协议**RTP**和**RTSP**。这样就增加了成本和复杂性

于是，现在对流式存储音频/视频的播放，如YouTube和Netflix，都采用TCP来传送。下图说明了使用TCP传送流式视频的几个主要步骤

<div align="center">    
<img src="./imgs/TCP传送流式视频.jpg" width="75%" height="75%">
</div>

1. 用户使用HTTP获取存储在万维网服务器中的视频文件，然后服务器把视频数据传送到TCP发送缓存中。若发送缓存已填满，就暂时停止传送
2. 从TCP发送缓存通过互联网向客户机中的TCP接收缓存传送视频数据，直到接收缓存被填满
3. 从TCP接收缓存把视频数据再传送到应用程序缓存(即媒体播放器的缓存)
4. 在播放时，媒体播放器等时地(即周期性地)把视频数据按帧读出，经过解压缩后，把视频节目显示在用户的屏幕上

只有第4步的读出速率是严格按照源视频文件的规定速率来播放。而前面三步的数据传送速率则可以使任意的。如果用户暂停播放，那么图中的三个缓存将很快被填满，这时TCP发送缓存就暂停读取所存储的视频文件。以后，媒体播放器每读出n bit，TCP发送缓存就可以从存储的视频文件再读取n bit。如果客户机中的两个缓存经常处于填满状态，就能较好地应付网上偶然出现的拥塞

如果第2步的传送速率小于第4步的读出速率，那么客户机中的两个缓存中的存量就会逐渐减少。当媒体播放器缓存的数据被取空后，播放就不得不暂停，直到后续的视频数据重新注入进来后才能再继续播放。**实践证明，只要在第2步的TCP平均传送速率达到视频节目规定的播放速率的两倍，媒体播放器一般就能流畅地播放网上的视频节目**

如果是观看实况转播，那么最好应当首先考虑使用UDP来传送。如果使用TCP传送，则当出现网络严重拥塞而产生播放的暂停时，就会使人难于接受。使用UDP传送时，即使因网络拥塞丢失了一些分组，对观看的感觉也会比突然出现暂停要好些

## 实时流式协议RTSP

RTSP已成为互联建议标准。RTSP是为了给流式过程增加更多的功能而设计的协议。RTSP本身并不传送数据，而仅仅是使媒体播放器能够**控制**多媒体流的传送，因此RTSP又称为**带外协议**(out-of-band protocol)

RTSP协议以客户服务器方式工作，它是一个应用层的**多媒体播放控制协议**，用来使用户在播放从互联网下载的实时数据时能够进行控制，如：暂停/继续、快退、快进等。因此，RTSP又称为"**互联网录像机遥控协议**"

RTSP的语法和操作与HTTP的相似(所有的请求和响应报文都是ASCII报文)，但与HTTP不同的是RTSP是有状态的协议(HTTP是无状态的)。RTSP记录客户机所处于的状态(初始化状态、播放状态或暂停状态)。RFC 2326规定，RTSP控制分组既可在TCP上传送，也可在UDP上传送。RTSP没有定义音频/视频流在媒体播放器中应如何缓存

下图表示使用RTSP协议的媒体服务器工作过程

<div align="center">    
<img src="./imgs/RTSP工作过程.jpg" width="50%" height="50%">
</div>

1. 浏览器使用HTTP的GET报文向万维网服务器请求音频/视频文件

2. 万维网服务器从浏览器发送携带有元文件的响应

3. 浏览器把收到的元文件传送给媒体播放器

4. 媒体播放器的RTSP客户发送SETUP报文与媒体服务器的RTSP服务器建立连接

5. 媒体服务器的RTSP服务器发送响应RESPONSE报文

6. 媒体播放器的RTSP客户发送PLAY报文开始下载音频/视频文件（即开始播放）

7. 媒体服务器的RTSP服务器发送响应RESPONSE报文

   此后，音频/视频文件被下载，所用的协议是运行在UDP上的。可以是后面要介绍的RTP，也可以是其他专用的协议。在音频/视频播放的过程中，媒体播放器可以随时暂停(利用PAUSE报文)和继续播放(利用PLAY报文)，也可以快进或快退

8. 用户在不想继续观看时，可以由RTSP客户发送TEARDOWN报文断开连接

9. 媒体服务器的RTSP服务器发送响应RESPONSE报文

以上4-9步都使用实时流协议RTSP，上图没有编号的"音频/视频流"则使用另外的传送音频/视频数据的协议，如**RTP**

